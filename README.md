# 🛒 Smart Shop - Система персональных рекомендаций

Smart Shop - это современная система рекомендаций для интернет-магазина продуктов, построенная на основе микросервисной архитектуры с использованием машинного обучения.

## 📋 Содержание

- [Возможности](#возможности)
- [Архитектура](#архитектура)
- [Требования](#требования)
- [Установка](#установка)
- [Запуск](#запуск)
- [Использование](#использование)
- [API документация](#api-документация)
- [Решение проблем](#решение-проблем)

## ✨ Возможности

- 🎯 **Персональные рекомендации** на основе истории покупок
- 📊 **Популярные товары** для новых пользователей
- 🔍 **Поиск товаров** по названию
- 🛒 **Корзина покупок** с сохранением между сессиями
- 📈 **Аналитика** предпочтений пользователя
- 🔐 **Аутентификация** с JWT токенами
- ⚡ **Кеширование** для быстрой работы

## 🏗️ Архитектура

```
┌──────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│   React App      │────▶│     Nginx        │────▶│   FastAPI App   │
│  (localhost:3000)│     │  (localhost:8000)│     │   (app:8080)    │
└──────────────────┘     └──────────────────┘     └───┬─────────────┘
                                                      │
                    ┌─────────────────────────────────┼──────────────┐
                    │                                 │              │
              ┌─────▼──────┐  ┌──────────────┐  ┌─────▼──────┐  ┌────▼──────┐
              │ PostgreSQL │  │    Redis     │  │  RabbitMQ  │  │ ML Worker │
              │   (5432)   │  │   (6379)     │  │   (5672)   │  │           │
              └────────────┘  └──────────────┘  └────────────┘  └───────────┘
```

### Компоненты системы:

- **Frontend (React)** - интерактивный веб-интерфейс
- **Nginx** - reverse proxy и балансировщик нагрузки
- **FastAPI** - основное API приложение
- **PostgreSQL** - база данных для хранения пользователей, товаров и заказов
- **Redis** - кеширование популярных товаров и рекомендаций
- **RabbitMQ** - очередь сообщений для асинхронных задач
- **ML Worker** - обработчик задач машинного обучения

## 📦 Требования

- Docker и Docker Compose
- Python 3.8+ (для загрузки данных)
- Аккаунт на [Kaggle](https://www.kaggle.com) (для загрузки датасета)
- Минимум 4GB свободной памяти
- 2GB свободного места на диске

## 🚀 Установка

### 1. Клонирование репозитория

```bash
git clone <repository-url>
cd mfdp
```

### 2. Настройка Kaggle API

Для загрузки данных необходимо настроить доступ к Kaggle API:

1. Зарегистрируйтесь на [Kaggle](https://www.kaggle.com)
2. Перейдите в настройки аккаунта: https://www.kaggle.com/account
3. В разделе API нажмите "Create New API Token"
4. Скачается файл `kaggle.json`
5. Создайте директорию и поместите туда файл:

```bash
mkdir -p ~/.kaggle
mv ~/Downloads/kaggle.json ~/.kaggle/
chmod 600 ~/.kaggle/kaggle.json
```

### 3. Загрузка данных

```bash
# Установка зависимостей для скрипта
pip install -r requirements.txt

# Загрузка датасета Instacart
python download_data.py
```

Скрипт автоматически:
- Проверит наличие учетных данных Kaggle
- Загрузит датасет (~1.3 GB)
- Распакует файлы в папку `data/`
- Удалит архив после распаковки

### 4. Настройка переменных окружения

Файл `.env` уже настроен и готов к использованию. При необходимости можете изменить пароли:

```env
DB_HOST=db
DB_PORT=5432
DB_USER=postgres
DB_PASS=postgres
DB_NAME=sa
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
POSTGRES_DB=sa
DEBUG=False
SECRET_KEY=d3415ad92f1a1e9cfeca4bf84e5ad841cf3d19e8dfa861505fa0351d30589
REDIS_HOST=redis
REDIS_PORT=6379
RABBITMQ_USER=rmuser
RABBITMQ_PASS=rmpassword
```

## 🎮 Запуск

### 1. Запуск всех сервисов

```bash
# Сборка и запуск контейнеров
docker-compose up -d --build

# Проверка статуса
docker-compose ps
```

### 2. Инициализация базы данных

Подождите 10-15 секунд после запуска контейнеров, затем:

```bash
# Загрузка данных в БД (полная загрузка)
docker-compose exec app python -m app.database.import_fast

# ИЛИ загрузка с ограничением (быстрее для тестирования)
docker-compose exec app python -m app.database.import_fast 100
```

### 3. Запуск фронтенда (опционально)

Если хотите запустить React приложение локально:

```bash
cd smart-shop-frontend
npm install
npm start
```

## 🌐 Использование

После запуска доступны следующие сервисы:

- **Web интерфейс**: http://localhost:3000
- **API**: http://localhost:8000
- **API документация**: http://localhost:8000/docs
- **RabbitMQ Management**: http://localhost:15672
  - Логин: `rmuser`
  - Пароль: `rmpassword`

### Тестовый аккаунт

Для быстрого тестирования создайте тестового пользователя:

```bash
curl -X POST http://localhost:8000/auth/create-test-user
```

Учетные данные:
- Email: `admin@example.com`
- Пароль: `admin123`

### Работа с системой

1. **Регистрация/Вход** - создайте аккаунт или используйте тестовый
2. **Просмотр товаров** - изучайте популярные товары
3. **Поиск** - найдите нужные продукты
4. **Добавление в корзину** - соберите заказ
5. **Оформление заказа** - после 2-го заказа появятся персональные рекомендации
6. **Рекомендации** - система предложит товары на основе ваших предпочтений

## 📚 API документация

### Основные эндпоинты

#### Аутентификация
- `POST /auth/signup` - регистрация
- `POST /auth/login` - вход
- `GET /auth/me` - текущий пользователь

#### Товары
- `GET /products/` - список товаров
- `GET /products/{id}` - информация о товаре
- `GET /products/departments/list` - список отделов
- `GET /products/aisles/list` - список категорий

#### Рекомендации
- `GET /recommendations/` - получить рекомендации
- `GET /recommendations/preferences` - предпочтения пользователя
- `POST /recommendations/generate/{model_type}` - генерация рекомендаций

#### Заказы
- `POST /orders/` - создать заказ
- `GET /orders/` - история заказов
- `GET /orders/{id}` - детали заказа

Полная документация доступна по адресу: http://localhost:8000/docs

## 🛠️ Управление системой

### Просмотр логов

```bash
# Все сервисы
docker-compose logs -f

# Конкретный сервис
docker-compose logs -f app
docker-compose logs -f ml_worker
docker-compose logs -f nginx
```

### Остановка системы

```bash
# Остановка контейнеров
docker-compose down

# Остановка с удалением данных
docker-compose down -v
```

### Перезапуск сервиса

```bash
docker-compose restart app
```

### Проверка данных в БД

```bash
docker-compose exec app python check_db.py
```

## 🐛 Решение проблем

### "Connection refused" при запуске

**Проблема**: Сервисы еще не запустились полностью.

**Решение**: Подождите 15-20 секунд после `docker-compose up -d`.

### Ошибка при загрузке данных

**Проблема**: "COPY file not found" или подобная ошибка.

**Решение**: 
1. Убедитесь, что выполнили `python download_data.py`
2. Проверьте наличие файлов в папке `data/`
3. Перезапустите контейнеры

### Нет персональных рекомендаций

**Проблема**: Рекомендации появляются только после 2-го заказа.

**Решение**:
1. Сделайте минимум 2 заказа
2. Нажмите "Сгенерировать рекомендации" в интерфейсе
3. Обновите страницу

### Очистка и полный перезапуск

```bash
# Остановка и удаление всего
docker-compose down -v
docker system prune -f

# Заново запустить
docker-compose up -d --build
# Подождать 15 секунд
docker-compose exec app python -m app.database.import_fast
```

## 📝 Примечания

- Первый запуск может занять 5-10 минут (сборка образов)
- Загрузка полного датасета занимает ~2-3 минуты
- Для быстрого тестирования используйте ограниченную загрузку (100 пользователей)
- Данные сохраняются в Docker volumes и переживают перезапуск контейнеров

## 🤝 Поддержка

Если у вас возникли проблемы:
1. Проверьте логи: `docker-compose logs -f`
2. Убедитесь, что все порты свободны (3000, 8000, 5432, 6379, 5672, 15672)
3. Проверьте наличие всех файлов данных в папке `data/`
